# 作者信息

| 用户名 | 推特 | 真实名字 | 简介 |
|--------|---------|------|--------|
| Seek | seek_web3 | ShiJiang.Guo | DappLink and The Web3 创始人, 曾就职于 Mantle, Bybit, 昆仑万维, HBTC, 币信, ChainUp, 云控蜂核, Achain, Linkeye, Kcash, Biwork, 华夏银行,中信银行|

# 第五节：区块链数据存储与账本管理

区块链作为一种去中心化的分布式账本，其核心技术是数据的存储与账本管理。本文通过 Ethereum 与 Bitcoin 两个典型案例，详细阐述了区块链如何确保数据的安全、透明和一致。

## 一.Ethereum 数据存储与账本管理

### 1.整体架构概述

Ethereum 区块链通过区块（Block）来存储和管理数据，每个区块又分为两大部分：

- Header（区块头）：记录元数据，用于维护区块链的完整性。
- Body（区块主体）：包含交易信息和 Ommer（叔块）信息。

### 2.区块头（Block Header）
区块头记录了本区块最关键的索引与校验信息，具体包括：

- parentHash：前一区块的哈希值。
- ommersHash：叔块（Ommers）的哈希值。
- beneficiary：挖矿奖励接收地址。
- stateRoot：世界状态的根节点哈希值。
- receiptsRoot：交易回执的根节点哈希值。
- transactionRoot：交易数据的根节点哈希值。
- logsBloom：日志的布隆过滤器，快速检索日志事件。
- difficulty：挖矿难度（PoS后废弃）。
- number：区块高度（区块号）。
- gasLimit：Gas上限。
- gasUsed：实际使用的Gas。
- timestamp：时间戳。
- extraData：额外数据。
- mixHash：随机性相关哈希值。
- nonce：挖矿随机数（PoS后废弃）。

### 3.区块主体（Block Body）
区块主体包括两类数据：

- 交易列表（List of Transactions）
- 叔块列表（List of Ommers），用于记录未被主链纳入但有效的区块（可获得部分奖励）。

### 4.关键数据结构——Patricia Trie（前缀树）
Ethereum 使用Modified Merkle Patricia Trie (MPT) 存储三大类重要数据：

- 世界状态树（World State Trie）
- 交易树（Transactions Trie）
- 交易回执树（Receipts Trie）

#### 4.1.世界状态树（World State Trie）
存储所有账户的当前状态，每个账户的状态由以下四项构成：

- nonce：账户的交易数量。
- balance：账户的以太币余额。
- storageRoot：账户存储空间（智能合约）的根节点哈希值。
- codeHash：账户关联代码的哈希（普通账户为空，合约账户存储智能合约字节码的哈希）。

#### 4.2.账户存储树（Account Storage Trie）
当账户是智能合约账户时，其持久化数据通过单独的 MPT 存储，树的根节点为账户状态中的 storageRoot。

- 存储智能合约变量（状态数据）。
- 每次变量修改会更新 storageRoot，从而更新世界状态树。

#### 4.3.交易树（Transactions Trie）
每个区块的所有交易数据会以树状结构存储，树的根节点哈希值记录于区块头中的 transactionRoot 中。

交易（Transaction）详细结构：

- nonce：发送者地址的交易序号。
- gasPrice：Gas 单价。
- gasLimit：交易的最大 Gas 使用量。
- to：接收方地址（合约部署时为空）。
- value：发送的以太币数量。
- v, r, s：ECDSA 签名相关的参数。
- data：调用合约的输入数据。
- init：部署合约时，初始化的字节码（仅合约部署时使用）。

#### 4.4.交易回执树（Receipts Trie）
每次交易执行后产生的回执数据存储于此，根节点记录于区块头的 receiptsRoot。

交易回执内容主要包括：
- 状态执行结果：成功或失败。
- Gas 消耗情况。
- 合约执行日志（Logs）：事件数据。


### 5.账本状态的更新流程
Ethereum 状态更新的核心流程：

- 发起交易: 用户签名并广播交易。
- 打包交易: 验证节点选择并打包交易入区块主体（Body）。
- 执行交易:
  - 根据交易数据更新世界状态树（账户余额、nonce变化）。
  - 如果是合约调用，则更新合约的账户存储树，修改智能合约数据。
- 更新 MPT: 完成状态更新后，重新计算世界状态树、交易树、回执树各自的根节点哈希，并记录到区块头中。
- 形成区块: 记录所有变化后生成新区块，传播到网络。

### 6.核心优势
Ethereum 这种基于 MPT 的账本设计有以下几个显著优势：

- 状态完整性：任何状态更改都会反映在根节点哈希中，防止数据被篡改。
- 快速校验：通过 Merkle proof 可以高效校验任意数据是否存在于树中。
- 存储优化：共享前缀数据，有效降低数据冗余。

以上就是 Ethereum 数据存储与账本管理机制的完整解说，这种数据结构和管理方式，确保了以太坊网络安全、快速的数据验证和高效的数据存储，奠定了区块链应用平台的坚实基础。

## 二.Bitcoin 数据存储与账本管理

### 1.整体概念概述
Bitcoin 的账本采用**区块链（Blockchain）**结构，每个区块包含大量的交易数据，以链式结构连接形成去中心化的账本。

UTXO (未花费交易输出) 是 Bitcoin 数据存储的核心：

- 每笔交易的输入（Input）来自前一笔交易的输出（Output）。
- 未花费的输出被称为 UTXO（Unspent Transaction Output）。

### 2.节点类型
Bitcoin 网络中的节点主要有两种：

#### 2.1.轻节点（SPV节点）

- 不存储完整区块链，只保存区块头。
- 通过 Merkle Proof 来验证与自身有关的交易是否包含在区块内。
- 验证挖矿难度，确保自己位于最长的链。

#### 2.2.全节点（Full Node）
- 存储完整的区块链数据。
- 负责完整验证所有交易的合法性：
  - 防止双花（Double Spending）。
  - 验证数字签名。
- 决定遵循哪条链（最长链原则）。
- 监听矿工挖出的区块是否合法。

### 3.区块结构

Bitcoin 区块包含两大部分：

#### 3.1.区块头（Block Header）
包含用于验证和链接前后区块的元数据：

- 版本号 (Version)
- 前一区块的哈希 (Previous Block Hash)
- Merkle根哈希 (Merkle Root Hash)
- 时间戳 (Timestamp)
- 难度目标 (Difficulty Target)
- Nonce（随机数），用于工作量证明（PoW）

#### 3.2.区块体（Block Body）

存储了实际的交易记录（最多约4000笔，区块大小限制1M，每交易约250字节）。

### 4.Merkle 树与数据存储
Bitcoin 使用**Merkle树（Merkle Tree）**保证区块内交易数据的一致性：
- 每个交易通过哈希函数计算出哈希值。
- 两两哈希形成下一层节点，直至形成顶端根哈希（Root Hash）。
- 根哈希存储在区块头中，任何轻节点均可利用Merkle Proof来验证某笔交易是否存在于某个区块，而无需存储整个区块的详细信息。

优点：
- 高效的验证机制，节约轻节点存储空间。
- 确保了区块链数据的安全性与不可篡改性。

### 5.矿池与挖矿流程
Bitcoin 采用 **PoW（工作量证明）**共识机制，通过矿工竞争算力来生成区块：

流程：
- 矿池管理者（Pool Manager）分配待计算区块给矿工。
- 每个矿工（Miner）计算对应的哈希值，找到符合难度目标的随机数（Nonce）。
- 找到合适哈希值后，矿工将结果提交给矿池，由矿池再将区块广播到全网。
- 其他节点验证区块合法后，区块加入链中。

### 6.防止双花攻击（Double Spending）

Bitcoin 防止双花攻击主要依靠：

- UTXO 模型：每个输入交易必须来自有效且未花费的输出。
- 最长链规则：
  - 如果存在分叉，网络认可拥有最多工作量的链为合法主链，短链将被放弃。
  - 双花攻击者必须掌控超过 51% 算力，才能操纵最长链，非常困难。

示例交易流程防止双花：

- 假设一笔交易A→B、B→C、C→D。
- 如果攻击者想重复花费已使用过的资金（如再次A→E），则攻击者必须重新挖掘该区块，并超越主链长度，这几乎不可能。

### 7.区块分叉与区块链重组

Bitcoin 网络偶尔会发生分叉（fork）：

- 硬分叉（Hard Fork）：规则发生重大变化，旧节点不兼容。
- 软分叉（Soft Fork）：新旧节点可兼容，但新节点严格化规则。

当分叉发生时，节点选择最长链为主链，其他短链逐步放弃，最终实现共识，防止数据不一致。

### 8.区块内容关键词释义

常见术语：
- 交易数量（Number of transactions）：区块中包含的交易总数。
- 输出总额（Output total）：区块所有交易的输出金额总和。
- 预估交易金额（Estimated transaction value）：区块内交易金额的预估值。
- 交易费（Transaction fees）：矿工获得的交易手续费总和。
- 区块奖励（Block reward）：矿工获得的奖励（目前每个区块奖励6.25 BTC，每约4年减半）。
- 时间戳（Timestamp）：区块创建的精确时间。
- 难度（Difficulty）：网络调整的挖矿难度，约每2016个区块（约两周）调整一次。
- 区块大小（Size）：区块数据量大小。
- Nonce值（Nonce）：矿工通过试错法寻找的随机数，用于满足难度要求。

### 9.哈希值（Hashes）
重要哈希值说明：

- 当前区块的头部哈希（Hash）：用于识别和验证当前区块的唯一哈希值。
- 前一区块的头部哈希（Previous Block）：用于链接前一区块的哈希。
- 后一区块头部哈希（Next Blocks）：下一区块的头部哈希。
- Merkle 根哈希（Merkle Root）：区块中所有交易数据计算出的 Merkle 树的根节点哈希值。

### 10.小结与优势总结

Bitcoin 账本管理通过以下特点，确保账本安全、稳定、可靠：

- UTXO 模型保障资金使用记录的唯一性，防范双花。
- 区块链结构保证历史数据不可篡改。
- Merkle 树确保高效的交易验证。
- PoW 共识机制确保数据安全和全网共识。
- 最长链原则保障网络一致性。

这些技术措施共同构成了 Bitcoin 强大的账本存储与管理体系，是比特币网络安全稳定运行的重要基础。

## 三.Ethereum 与 Bitcoin 的对比

| 维度     | Ethereum           | Bitcoin               |
| ------ | ------------------ | --------------------- |
| 数据结构   | 账户模型、MPT 树         | UTXO 模型、Merkle 树      |
| 状态管理   | 世界状态树动态维护账户余额与状态   | UTXO 集合维护资产所有权        |
| 交易执行模型 | 智能合约（虚拟机执行）        | 简单交易转账，无合约逻辑          |
| 存储与验证  | 状态根哈希、交易根哈希、回执树根哈希 | Merkle 树根哈希（仅交易）      |
| 轻节点支持  | 通过MPT树验证账户状态与交易    | 通过Merkle Proof验证交易存在性 |
| 共识机制   | PoS (早期PoW，现PoS)   | PoW                   |
| 防双花机制  | 账户Nonce机制，状态一致性    | UTXO，最长链原则            |


## 四.数据存储与账本管理的意义
Ethereum 与 Bitcoin 在账本管理中的技术各具特色，但核心理念一致：

数据不可篡改：通过链式结构、哈希验证确保历史数据真实可靠。

高效验证：通过 Merkle 树或 MPT 树高效验证数据存在性。

防止双花：账户模型或UTXO模型防范资金重复使用，保障资产安全。

共识一致性：利用共识机制维护网络一致性与安全性。

## 五.总结
Ethereum 和 Bitcoin 分别以账户模型与UTXO模型为基础，通过区块链、Merkle 树等数据结构，配合PoW/PoS共识机制，实现了安全、高效、不可篡改的数据存储与账本管理体系。两种模型为区块链技术的发展提供了清晰的思路和丰富的实践经验，成为构建去中心化信任体系的重要基石。

















